<!DOCTYPE html>
<html>
    <head>
        <title>Hello WS</title>
        <meta charset="utf-8">
        <meta http-equiv="cache-control" content="no-cache" />

        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="stylesheet" media="screen"
            href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" />

        <script type="text/javascript"
                src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
        <script type="text/javascript"
                src="https://www.google.com/jsapi"></script>
        <script type="text/javascript"
                src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.14/angular.min.js"></script>

        <script type="text/javascript">

            function ReconnectingSocket (reconnectTimeoutMs, url, onMessage) {
                var self = this;
                var onOpen = function(event) {
                    console.log("Connected " + event.currentTarget.url);
                }
                var onClose = function(event) {
                    console.log("Closed " + event.currentTarget.url);
                    setTimeout(function() { self.reconnect(); }, reconnectTimeoutMs);
                }
                self.reconnect = function() {
                    console.log("Connecting " + url);
                    self.socket = new WebSocket(url);
                    self.socket.onopen = onOpen;
                    self.socket.onmessage = onMessage;
                    self.socket.onclose = onClose;
                }
                self.reconnect();
            }

            var mainModule = angular.module('main', []);

            mainModule.controller('MainCtrl', ['$scope', '$http', function($scope, $http) {
                var readerSocket = new ReconnectingSocket(2000, "ws://" + window.location.host + "/read", function(event) {
                    console.log("Received: " + event.data);
                    $scope.$apply(function() {
                    });
                });
                var writerSocket = new ReconnectingSocket(2000, "ws://" + window.location.host + "/write", function(event) {});

                $scope.send = function(message) {
                    writerSocket.socket.send(message);
                }
            }]);

        </script>
        <style type="text/css">
            .input-loading {
                background: url('assets/loading.gif') no-repeat right 10px center;
            }
            .footer {
                padding-top: 20px;
                padding-bottom: 30px;
                margin-top: 40px;
                border-top: 1px solid #eee;
                color: #888;
                font-size: smaller;
            }
        </style>
    </head>
    <body ng-app="main">
        <div class="container" ng-controller="MainCtrl">
            <div class="row">
                <div class="col-lg-12"><h1>Hello</h1></div>
            </div>
            <div class="row">
                <div class="col-lg-12">
                    <button type="button" class="btn btn-default" ng-click="send('lalala')">Send 1</button>
                    <button type="button" class="btn btn-default" ng-click="send('foobar')">Send 2</button>
                </div>
            </div>

            <div class="footer">
                <p>&copy; <a href="https://github.com/dryewo">Dmitry Balakhonskiy</a> 2014</p>
            </div>
        </div>

    </body>
</html>
